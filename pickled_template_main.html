<!DOCTYPE html>
<html lang="it">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>PICKLED – Because broken routers don’t explain themselves</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css">
        <link rel="icon" type="image/png" href="data:image/png;base64,{{ favicon }}">
        <style>
            :root {
                --primary-light: #0f5350;
                --primary-main: #2d8371;
                --primary-main-trans: rgba(45, 131, 113, 0.5);
                --primary-dark: #aacf76;
                --petrol: #02433e;
                --petrol-dark: #01201e;
                --petrol-light: #0d4d49;
                --petrol-light50: rgba(13, 77, 73, 0.5);
                --accent-color: #ff8a65;
                --light-color: #f1f8e9;
                --dark-color: #263238;
                --gray-light: #e8f5e9;
                --gray-medium: #c8e6c9;
                --gray-medium-trans: rgba(200, 230, 201, 0.4);
                --gray-dark: #2e7d32;
                --bg-gradient-start: #e6f3e0;
                --bg-gradient-end: #d0e6c5;
            }

            body {
                background: linear-gradient(135deg, 
                var(--bg-gradient-start) 0%, 
                var(--bg-gradient-end) 100%);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                margin: 0;
                padding: 20px;
                background-color: var(--light-color);
                color: var(--dark-color);
            }

            .switch-table th:nth-child(4) {
                position: relative;
                padding-right: 120px;
            }

            .per-page-selector {
                position: absolute;
                right: 10px;  
                top: 50%;
                transform: translateY(-50%);
            }

            .per-page-selector select {
                padding: 3px;
                border-radius: 3px;
                border: 1px solid #ddd;
                background-color: white;
                font-size: 12px;
                width: auto;
                height: 50%;
            }

            .log {
                margin-top: 30px;
                max-height: 300px;
                overflow-y: auto;
                background-color: #1a1a1a;
                color: #e0e0e0;
                padding: 15px;
                border-radius: 4px;
                font-family: monospace;
                white-space: pre-wrap;
                font-size: 14px;
                line-height: 1.5;
            }

            .log div {
                margin-bottom: 5px;
                padding: 3px 5px;
                border-radius: 3px;
            }

            .log div:hover {
                background-color: #2a2a2a;
            }

            .app-container {
                display: flex;
                min-height: calc(100vh - 40px);
                gap: 20px;
            }

            .copy-tooltip {
                position: relative;
                display: block;
                cursor: pointer;
                margin-top: 20px;
            }

            .copy-tooltip .tooltiptext {
                visibility: hidden;
                width: 140px;
                background-color: #333;
                color: #fff;
                text-align: center;
                border-radius: 4px;
                padding: 5px;
                position: absolute;
                z-index: 1001;  
                bottom: calc(100% - 10px);  
                left: 50%;
                transform: translateX(-50%);
                opacity: 0;
                transition: opacity 0.3s;
                font-size: 13px;
                font-family: Arial, sans-serif;
                pointer-events: none;
            }

            .copy-tooltip:hover .tooltiptext {
                visibility: visible;
                opacity: 1;
            }

            .copy-tooltip.copied .tooltiptext {
                background-color: #4CAF50;
            }

            .config-content {
                font-family: monospace;
                white-space: pre;
                background-color: #f8f8f8;
                padding: 15px;
                border-radius: 4px;
                max-height: 70vh;
                overflow-y: auto;
                margin: 0;
                border: 1px solid #ddd;
                position: relative;
            }

            .left-panel {
                width: 200px;
                background-color: white;
                padding: 15px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
                border: 1px solid var(--gray-medium);
                position: relative;
            }

            .left-panel > button {
                width: calc(100%);
                padding: 12px;
                margin-top: 5px;
            }

            .left-panel > .version-footer {
                position: absolute;
                bottom: 15px;
                left: 15px;
                right: 15px;
                font-size: 12px;
                color: var(--petrol);
                text-align: center;
                padding: 0 10px;
            }

            .center-panel {
                flex: 1;
                background-color: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
                border: 1px solid var(--gray-medium);
                display: flex;
                flex-direction: column;
                margin: 0 20px;
                position: relative;
            }

            .device-list-background {
                position: absolute;
                top: 20%;
                left: 50%;
                transform: translateX(-50%);
                width: 40%;
                height: 40%;
                background-image: url("data:image/png;base64,{{ pickledlogo }}");
                background-size: contain;
                background-position: center;
                background-repeat: no-repeat;
                opacity: 0.12;
                z-index: 0;
                pointer-events: none;
            }

            .right-panel {
                width: 350px;
                background-color: white;
                padding: 15px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                display: flex;
                flex-direction: column;
            }

            .switch-table-container {
                flex: 1;
                overflow-y: auto;
                margin-top: 10px;
            }

            .search-container {
                display: flex;
                margin-bottom: 15px;
            }

            .search-container input {
                flex: 1;
                padding: 10px;
                border: 1px solid var(--gray-medium);
                border-radius: 4px;
            }      

            .pagination {
                display: flex;
                justify-content: center;
                align-items: center;
                margin-top: 15px;
                gap: 5px;
                flex-wrap: wrap;
            }

            h1, h2, h3 {
                color: var(--petrol);
            }

            .pagination button {
                padding: 5px 10px;
                background-color: var(--gray-light);
                color: var(--dark-color);
                border: 1px solid var(--gray-medium);
                border-radius: 4px;
                cursor: pointer;
                min-width: 32px;
                transition: all 0.2s;
            }

            .pagination button:hover:not(:disabled),
            .pagination button.active {
                background-color: var(--petrol-dark);
                color: white;
                border-color: var(--petrol-light);
            }

            .pagination button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .pagination button i {
                font-size: 14px;
            }

            h1 {
                color: var(--dark-color);
                text-align: center;
                margin-bottom: 30px;
            }

            h2 {
                color: var(--dark-color);
                border-bottom: 2px solid var(--primary-color);
                padding-bottom: 8px;
                margin-top: 0;
            }

            .form-group input {
                width: calc(100% - 24px);
                padding: 10px 12px;
                border: 1px solid var(--gray-medium);
                border-radius: 6px;
                font-size: 16px;
                transition: border-color 0.3s, box-shadow 0.3s;
            }

            .form-group input:focus {
                border-color: var(--primary-color);
                box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
                outline: none;
            }

            .form-group {
                margin-bottom: 10px;
            }

            .form-group label {
                display: block;
                margin-bottom: 5px;
                font-weight: 600;
                color: var(--petrol);
                font-size: 13px;
            }

            label {
                display: block;
                margin-bottom: 5px;
                font-weight: 600;
            }

            input {
                width: 100%;
                padding: 10px;
                border: 1px solid var(--gray-medium);
                border-radius: 4px;
                font-size: 16px;
                transition: all 0.3s;
            }

            button {
                background-color: var(--petrol);
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 16px;
                transition: background-color 0.3s;
            }

            button:hover {
                background-color: var(--primary-main);
                transform: translateY(-1px);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            }

            .status-container {
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 1000;
                max-width: 400px;
            }

            .status {
                padding: 15px;
                border-radius: 4px;
                margin-bottom: 10px;
                display: none;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            }

            .success {
                background-color: #c8e6c9;
                color: #2e7d32;
                border-left: 4px solid var(--primary-main);
            }

            .error {
                background-color: #ffcdd2;
                color: #c62828;
                border-left: 4px solid #ef5350;
            }

            .log-panel {
                flex: 1;
                overflow-y: auto;
                margin-top: 20px;
                background-color: #1a1a1a;
                color: #e0e0e0;
                padding: 15px;
                border-radius: 4px;
                font-family: monospace;
            }

            .switch-table {
                width: 100%;
                border-collapse: separate;
                border-spacing: 0;
                margin-top: 20px;
                border-radius: 8px;
                overflow: hidden;
                box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            }

            .switch-table th, .switch-table td {
                padding: 8px 12px;
                text-align: left;
                border-bottom: 1px solid var(--primary-main-trans);
            }

            .switch-table th {
                background-color: var(--petrol);
                color: white;
                cursor: pointer;
                user-select: none;
                position: sticky;
                top: 0;
            }

            .switches-table-tbody th:hover {
                background-color: var(--primary-hover);
            }

            .switch-table tr {
                line-height: 1;
            }

            .switches-table-tbody tr:hover {
                background-color: var(--gray-medium-trans);
            }

            .search-header-container {
                margin-bottom: 5px;
            }

            .search-button {
                padding: 4px 8px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 5px;
                border-radius: 4px;
                font-size: 13px;
                cursor: pointer;
                transition: all 0.2s;
                white-space: nowrap;
            }

            .search-button i {
                font-size: 12px;
            }

            .search-buttons {
                padding: 8px 12px;
                min-width: 100px;
                height: 36px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 5px;
            }

            .search-buttons-container {
                display: flex;
                gap: 8px;
                align-items: center;
            }

            .action-btn {
                padding: 6px 10px;
                margin: 0 2px;
                font-size: 14px;
                min-width: 30px;
                transition: all 0.2s ease;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }

            .action-btn:hover {
                transform: translateY(-1px);
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                opacity: 0.9;
            }

            .action-btn.backup-btn {
                background-color: var(--primary-main);
            }

            .action-btn.edit-btn {
                background-color: #ffb74d;
            }

            .action-btn.view-btn {
                background-color: #7986cb;
            }

            .action-btn.delete-btn {
                background-color: #e57373;
            }

            .action-btn.backup-btn:hover {
                background-color: var(--primary-dark);
            }

            .action-btn.edit-btn:hover {
                background-color: #ffa726;
            }

            .action-btn.view-btn:hover {
                background-color: #5c6bc0;
            }

            .action-btn.delete-btn:hover {
                background-color: #ef5350;
            }

            .search-button:hover,
            .search-buttons:hover {
                opacity: 0.9;
                transform: translateY(-1px);
            }

            .logout-btn {
                background-color: #e57373;
            }

            .logout-btn:hover {
                background-color: #ef5350;
            }

            .edit-btn {
                background-color: #ffb74d;
            }

            .edit-btn:hover {
                background-color: #ffa726;
            }

            .delete-btn {
                background-color: #e57373;
            }

            .delete-btn:hover {
                background-color: #ef5350;
            }

            .backup-btn {
                background-color: var(--primary-main);
            }

            .backup-btn:hover {
                background-color: var(--primary-dark);
            }

            .view-btn {
                background-color: #7986cb;
            }

            .view-btn:hover {
                background-color: #5c6bc0;
            }

            .backup-all-btn {
                margin-top: 20px;
                width: 100%;
            }

            .exp-btn {
                background-color: #2c3e50;
                color: white;
            }

            .modal {
                display: none;
                position: fixed;
                z-index: 1050;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
            }

            .modal-content,
            .log-modal-content {
                background-color: white;
                margin: 5% auto;
                padding: 20px;
                border-radius: 8px;
                width: 80%;
                max-width: 900px;
                max-height: 80vh;
                display: flex;
                flex-direction: column;
                overflow: auto;
                transition: all 0.3s ease;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                border: 1px solid var(--primary-main);
            }

            .modal-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
            }

            .modal-title {
                font-size: 1.5em;
                font-weight: bold;
            }

            .close-btn {
                font-size: 1.5em;
                cursor: pointer;
            }

            .modal-body {
                display: flex;
                min-height: 0;
                flex: 1; 
                gap: 15px;
                padding: 10px;
                min-height: 0; 
                overflow: auto;
            }

            .config-container {
                flex: 1;
                display: flex;
                flex-direction: column;
                min-height: 0;
                position: relative;
                overflow: auto;
                padding-right: 15px;
            }

            .backup-list {
                width: 20%;
                overflow-y: auto;
                min-width: 300px;
                max-height: 100%;
            }

            .backup-content {
                width: 70%;
                display: flex;
                flex-direction: column;
                min-height: 0;
                overflow: auto;
            }

            #backup-content-placeholder {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100%;
                color: #777;
            }

            #backup-content {
                background: #f8f8f8;
                border-radius: 4px;
                padding: 12px;
            }

            .backup-item {
                padding: 10px;
                margin-bottom: 5px;
                border-radius: 4px;
                cursor: pointer;
                color: --petrol-light;
            }

            .backup-item:hover {
                background-color: var(--gray-light);
            }

            .backup-item.active {
                background-color: var(--primary-dark);
                color: --petrol-dark;
            }

            .config-content {
                font-family: monospace;
                white-space: pre;
                background-color: #f8f8f8;
                padding: 15px;
                border-radius: 4px;
                overflow-y: auto;
                flex: 1;
                border: 1px solid #ddd;
                margin: 0;
                max-height: 100%;
            }

            .split-view {
                display: flex;
                width: 100%;
            }

            .form-column {
                flex: 1;
                padding: 0 10px;
            }

            .log-content {
                font-family: monospace;
                white-space: pre-wrap;
                background-color: #f8f8f8;
                padding: 15px;
                border-radius: 4px;
                max-height: 60vh;
                overflow-y: auto;
                width: calc(100% + 20px);
            }

            .log-line {
                margin: 0;
                padding: 2px 5px;
                border-radius: 2px;
                transition: background-color 0.2s;
            }

            .log-line:hover {
                background-color:  #e7f585; 
                cursor: default;
            }

            ::-webkit-scrollbar {
                width: 8px;
                height: 8px;
            }

            ::-webkit-scrollbar-track {
                background: #f1f1f1;
            }

            ::-webkit-scrollbar-thumb {
                background: #888;
                border-radius: 4px;
            }

            ::-webkit-scrollbar-thumb:hover {
                background: #555;
            }

            .file-input-container {
                margin-top: 15px;
            }

            .file-input-label {
                display: block;
                margin-bottom: 5px;
                font-weight: 600;
            }

            .file-input {
                width: calc(100% - 24px);
                padding: 8px 12px;
            }

            .backup-status {
                display: inline-block;
                margin-right: 5px;
                cursor: help;
            }

            .backup-status i {
                font-size: 10px;
                vertical-align: middle;
            }

            .backup-status:hover i {
                transform: scale(1.3);
            }

            .schedule-form {
                background-color: var(--gray-light);
                padding: 12px;
                border-radius: 6px;
                margin-bottom: 15px;
            }

            .schedule-form h3 {
                margin-top: 0;
                color: var(--dark-color);
                border-bottom: 1px solid var(--gray-medium);
                padding-bottom: 8px;
            }

            .schedule-option {
                display: none;
                margin-top: 10px;
            }

            .schedule-option.active {
                display: block;
            }

            .schedule-list {
                margin-top: 15px;
            }

            .schedule-item {
                padding: 10px;
                background-color: white;
                border: 1px solid var(--gray-medium);
                border-radius: 4px;
                margin-bottom: 10px;
            }

            .schedule-item-header {
                display: flex;
                justify-content: space-between;
                font-weight: bold;
            }

            .schedule-item-actions {
                display: flex;
                gap: 5px;
            }

            .schedule-item-actions button {
                padding: 2px 6px;
                font-size: 12px;
            }

            .select2-container {
                width: 100% !important;
                margin-bottom: 15px;
            }

            #search-input {
                height: 30px;
                padding: 5px 30px 5px 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                margin-right: 10px;
                transition: all 0.3s ease;
                width: 180px;
            }

            #search-input:focus {
                width: 250px;
                border-color: var(--primary-color);
                outline: none;
                box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
            }

            #search-input + .fa-search {
                font-size: 12px;
                right: 8px;
                top: 9px;
            }

            input:not([type="file"]):not([type="checkbox"]):not([type="radio"]),
            select {
                height: 32px;
                padding: 5px 10px;
                font-size: 14px;
            }

            footer {
                font-size: 12px;
                color: var(--petrol);
                text-align: center;
                margin-top: 20px;
                opacity: 0.8;
            }

            ::-webkit-scrollbar {
                width: 8px;
                height: 8px;
            }

            ::-webkit-scrollbar-track {
                background: var(--gray-light);
            }

            ::-webkit-scrollbar-thumb {
                background: var(--primary-main);
                border-radius: 4px;
            }

            @media (max-width: 1200px) {
                .app-container {
                    flex-direction: column;
                }

                .left-panel, .center-panel, .right-panel {
                    width: auto;
                }
            }

            .select2-container--default .select2-selection--single {
                height: 32px;
                border: 1px solid var(--petrol);
                border-radius: 4px;
                background-color: white;
                transition: all 0.3s;
            }

            .select2-container--default .select2-selection--single:hover {
                border-color: var(--primary-main);
            }

            .select2-container--default .select2-selection--single .select2-selection__rendered {
                color: var(--petrol);
                line-height: 30px;
                padding-left: 10px;
            }

            .select2-container--default .select2-selection--single .select2-selection__arrow {
                height: 30px;
                right: 6px;
            }

            .select2-container--default .select2-selection--single .select2-selection__arrow b {
                border-color: var(--petrol) transparent transparent transparent;
            }

            .select2-container--default.select2-container--open .select2-selection--single {
                border-color: var(--primary-main);
                box-shadow: 0 0 0 2px rgba(45, 131, 113, 0.2);
            }

            .select2-container--default.select2-container--open .select2-selection--single .select2-selection__arrow b {
                border-color: transparent transparent var(--petrol) transparent;
            }

            .select2-container--default .select2-results__option {
                padding: 6px 10px;
                color: var(--petrol);
            }

            .select2-container--default .select2-results__option--highlighted[aria-selected] {
                background-color: var(--petrol-light);
                color: white;
            }

            .select2-container--default .select2-search--dropdown .select2-search__field {
                border: 1px solid var(--petrol-light);
                border-radius: 4px;
                padding: 4px 8px;
                margin-bottom: 5px;
            }

            .select2-container {
                width: 100% !important;
                margin-bottom: 15px;
            }

            #device-type, #edit-device-type {
                width: calc(100%) !important;
                padding: 5px 10px !important;
                height: 32px !important;
            }

            .select2-container--default #device-type + .select2,
            .select2-container--default #edit-device-type + .select2 {
                width: calc(100%) !important;
                margin-bottom: 10px;
            }

            .select2-container--default .select2-selection--single .select2-selection__arrow {
                height: 30px !important;
            }

            .switch-table-container {
                width: 100%;
                height: calc(100vh);
                min-height: 300px;
                display: flex;
                flex-direction: column;
                position: relative;
                overflow: hidden;
                border: 0px;
            }

            .switch-table {
                width: 100%;
                margin: 0;
                border-collapse: collapse;
            }

            .switch-table thead {
                display: table;
                width: 100%;
                table-layout: fixed;
                background-color: var(--petrol);
                color: white;
            }

            .switch-table tbody {
                display: block;
                overflow-y: auto;
                max-height: calc(100vh - 50px);
                min-height: 300px;
                position: absolute;
                top: 40px;
                bottom: 0;
                left: 0;
                right: 0;
            }

            .switch-table tr {
                display: table;
                width: 100%;
                table-layout: fixed;
            }

            .switch-table tbody::-webkit-scrollbar {
                width: 8px;
            }

            .switch-table tbody::-webkit-scrollbar-track {
                background: #f1f1f1;
            }

            .switch-table tbody::-webkit-scrollbar-thumb {
                background: #888;
                border-radius: 4px;
            }

            .switch-table tbody::-webkit-scrollbar-thumb:hover {
                background: #555;
            }

            .action-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                background-color: #cccccc !important;
            }

            .fa-spinner {
                margin-right: 5px;
            }
        </style>
    </head>

    <body>
        <div class="status-container">
            <div id="status-message" class="status"></div>
        </div>
        
        <div class="app-container">
            <div class="left-panel">
                <h2>Add device</h2>
                <div class="form-group">
                    <label for="hostname">Hostname:</label>
                    <input type="text" id="hostname" placeholder="Es: Switch1">
                </div>
                <div class="form-group">
                    <label for="ip">IP Address:</label>
                    <input type="text" id="ip" placeholder="Es: 192.168.1.1">
                </div>
                <div class="form-group">
                    <label for="username">Username:</label>
                    <input type="text" id="username" placeholder="Username SSH">
                </div>
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" placeholder="Password SSH">
                </div>
                <div class="form-group">
                    <label for="enable-password">Enable Password (optional):</label>
                    <input type="password" id="enable-password" placeholder="Enable/Secret password">
                </div>

                <div class="form-group">
                    <label for="device-type">Device Type:</label>
                    <select id="device-type" class="form-control">
                        <option value="cisco_ios">cisco_ios</option>
                        <option value="cisco_xe">cisco_xe</option>
                        <option value="cisco_xr">cisco_xr</option>
                        <option value="huawei">huawei</option>
                        <option value="juniper_junos">juniper_junos</option>
                        <option value="mellanox">mellanox</option>
                        <option value="mellanox_mlnxos">mellanox_mlnxos</option>
                    </select>
                </div>

                <button onclick="addSwitch()" class="addsw-btn">Add Device</button>

                <h2 style="margin-top: 30px;">Load CSV</h2>
                <div class="file-input-container">
                    <label class="file-input-label" for="csv-file">Select CSV file:</label>
                    <input type="file" id="csv-file" class="file-input" accept=".csv">
                </div>

                <button class="csv-btn" onclick="uploadCSV()">
                    <i class="fas fa-file-import"></i> Load CSV
                </button>

                <div class="version-footer">
                    PICKLED v{{ version }}<br/>Network Configuration Manager
                </div>
            </div>
            
            <div class="center-panel">
                <div class="device-list-background"></div>

                <div class="search-header-container">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0;">Device List</h2>
                        <div class="search-buttons-container">
                            <div style="position: relative;">
                                <input type="text" id="search-input" placeholder="Search devices..." 
                                style="padding: 5px 30px 5px 10px; border: 1px solid #ddd; border-radius: 4px; height: 30px; margin-right: 10px;"
                                oninput="filterSwitches()">
                                <i class="fas fa-search" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #777;"></i>
                            </div>
                            <button class="search-button exp-btn" onclick="exportSwitchesToCSV()">
                                <i class="fas fa-file-export"></i> Export
                            </button>
                            <button class="search-button backup-btn" onclick="backupAllSwitches()">
                                <i class="fas fa-download"></i> Backup All
                            </button>
                            <button class="search-button logout-btn" onclick="window.location.href='/logout'">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="switch-table-container">
                    <table class="switch-table">
                        <thead>
                            <tr>
                                <th onclick="sortTable(0)">Hostname <i class="fas fa-sort"></i></th>
                                <th onclick="sortTable(1)">IP <i class="fas fa-sort"></i></th>
                                <th onclick="sortTable(2)">Username <i class="fas fa-sort"></i></th>
                                <th>Actions
                                    <span class="per-page-selector">
                                        <select id="items-per-page" onchange="changeItemsPerPage()">
                                            <option value="5">5</option>
                                            <option value="10">10</option>
                                            <option value="15" selected>15</option>
                                            <option value="20">20</option>
                                            <option value="50">50</option>
                                            <option value="100">100</option>
                                        </select>
                                    </span>
                                </th>
                            </tr>
                        </thead>

                        <tbody id="switches-table-tbody" class="switches-table-tbody">
                        <!-- Le righe della tabella verranno aggiunte qui dinamicamente -->
                        </tbody>
                    </table>
                </div>

                <!-- Paginazione -->
                <div class="pagination" id="pagination">
                <!-- Popolato dinamicamente da JavaScript -->
                </div>
            </div>

            <!-- Colonna destra - Scheduler e log -->
            <div class="right-panel">
                <h2>Backup Scheduler</h2>

                <div class="schedule-form">
                    <h3>New Schedule</h3>

                    <div class="form-group">
                        <label for="schedule-type">Type:</label>
                        <select id="schedule-type" class="form-control" onchange="showScheduleOptions()">
                            <!--<option value="once">One Time</option>-->
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="schedule-time">Hour:</label>
                        <input type="time" id="schedule-time" class="form-control" value="00:00">
                    </div>

                    <!-- Opzioni specifiche per tipo -->
                    <div id="once-option" class="schedule-option">
                        <div class="form-group">
                            <label for="schedule-date">Data:</label>
                            <input type="date" id="schedule-date" class="form-control">
                        </div>
                    </div>

                    <div id="weekly-option" class="schedule-option">
                        <div class="form-group">
                            <label for="schedule-day-week">Giorno settimana:</label>
                            <select id="schedule-day-week" class="form-control">
                                <option value="0">Monday</option>
                                <option value="1">Tuesday</option>
                                <option value="2">Wednesday</option>
                                <option value="3">Thursday</option>
                                <option value="4">Friday</option>
                                <option value="5">Saturday</option>
                                <option value="6">Sunday</option>
                            </select>
                        </div>
                    </div>

                    <div id="monthly-option" class="schedule-option">
                        <div class="form-group">
                            <label for="schedule-day-month">Day month:</label>
                            <input type="number" id="schedule-day-month" min="1" max="31" value="1" class="form-control">
                        </div>
                    </div>

                    <div id="yearly-option" class="schedule-option">
                        <div class="form-group">
                            <label for="schedule-month">Month:</label>
                            <select id="schedule-month" class="form-control">
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="schedule-day-year">Day:</label>
                            <input type="number" id="schedule-day-year" min="1" max="31" value="1" class="form-control">
                        </div>
                    </div>

                    <button onclick="addSchedule()" class="backup-btn">
                        <i class="fas fa-calendar-plus"></i> Add Schedule
                    </button>
                </div>

                <div class="schedule-list" id="schedules-list">
                <!-- Lista delle pianificazioni verrà popolata dinamicamente -->
                </div>


                <div id="status-message" class="status"></div>

                <h2 style="margin-top: 30px;">Activity Log</h2>
                <div id="log" class="log">Ready to backup...</div>

                <button onclick="openLogModal()" style="margin-top: 10px; width: 100%;">
                    <i class="fas fa-scroll"></i> Show log
                </button>
            </div>
        </div>

        <!-- Modal con l'elenco dei backup -->
        <div id="backup-modal" class="modal" style="z-index:1000">
            <div class="modal-content" style="width: 90%; max-width: 1400px; height: 85vh;">
                <div class="modal-header">
                    <div class="modal-title">
                        Available backup by <span id="modal-switch-name"></span>
                    </div>
                    <span class="close-btn" onclick="closeConfigModal()">&times;</span>
                </div>

                <div class="modal-body" style="height: calc(100% - 60px);">
                    <!-- Lista backup più stretta (25%) -->
                    <div class="backup-list-container" id="backup-list-container" style="width: 25%; min-width: 220px; border-right: 1px solid #eee; padding-right: 15px;">
                        <button class="action-btn export-all-btn" id="export-all-backup-btn" style="padding: 5px 12px; font-size: 13px;" onclick="exportAllBackup()">
                            <i class="fa-solid fa-code-compare"></i> Export All
                        </button>
                        <div class="backup-list" id="backup-list">
                        <!-- Lista dei backup generata dinamicamente -->
                        </div>
                    </div>

                    <!-- Contenuto principale più ampio (75%) -->
                    <div class="backup-content" style="width: 75%;">
                        <div id="backup-content-placeholder">
                            <i class="fas fa-arrow-left" style="font-size: 24px; color: #ccc; margin-bottom: 10px;"></i>
                            <p>Select a backup from the list to view content</p>
                        </div>

                        <div id="backup-content" style="display: none; flex-direction: column; height: 100%;">
                            <!-- Barra dei bottoni compatta -->
                            
                            <div id="backup-button-bar" style="display: flex; justify-content: flex-end; gap: 8px; padding: 8px 0; margin-bottom: 12px;">
                                <!-- to be filled by the script -->

                                <!--
                                <button class="action-btn compare-btn" id="compare-select-btn" onclick="openCompareSelectModal()" style="padding: 5px 12px; font-size: 13px;">
                                    <i class="fa-solid fa-code-compare"></i> Compare
                                </button>
                                <button class="action-btn backup-btn" id="export-backup-btn" style="padding: 5px 12px; font-size: 13px;">
                                    <i class="fas fa-download"></i> Export
                                </button>
                                <button class="action-btn delete-btn" id="delete-backup-btn" style="padding: 5px 12px; font-size: 13px;">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                                -->
                            </div>

                            <!-- Contenuto configurazione -->
                            <div class="config-container" style="flex: 1; overflow-y: auto; background: #f8f8f8; border-radius: 4px; padding: 15px;">
                                <div class="copy-tooltip" onclick="copyToClipboard(this)" style="position: relative;">
                                    <span class="tooltiptext">Copy to clipboard</span>
                                    <pre class="config-content" style="white-space: pre-wrap; margin: 0; font-family: 'Courier New', monospace; font-size: 13px;"></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal con l'elenco dei backup da confrontare -->
        <div id="compare-select-modal" class="modal" style="z-index:1010">
            <div class="modal-content" style="width: 90%; max-width: 1400px; height: 85vh;">
                <div class="modal-header">
                    <div class="modal-title">
                        Select backup of <span id="modal-switch-name"></span> to compare:
                    </div>
                    <span class="close-btn" onclick="closeCompareSelectModal()">&times;</span>
                </div>

                <div class="modal-body" style="height: calc(100% - 60px);">
                    <!-- Lista backup più stretta (25%) -->
                    <div class="backup-list" id="backup-list" style="width: 25%; min-width: 220px; border-right: 1px solid #eee; padding-right: 15px;">
                    <!-- Lista dei backup -->
                    </div>

                    <!-- Contenuto principale più ampio (75%) -->
                    <div class="backup-content" style="width: 75%;">
                        <div id="backup-content-placeholder">
                            <i class="fas fa-arrow-left" style="font-size: 24px; color: #ccc; margin-bottom: 10px;"></i>
                            <p>Select a backup from the list to view content</p>
                        </div>

                        <div id="backup-content" style="display: none; flex-direction: column; height: 100%;">
                            <!-- Barra dei bottoni compatta -->
                            <div style="display: flex; justify-content: flex-end; gap: 8px; padding: 8px 0; margin-bottom: 12px;">
                                <button class="action-btn compare-confirm-btn" id="compare-confirm-btn" onclick="TO_BE_CHANGED()" style="padding: 5px 12px; font-size: 13px;">
                                    <i class="fa-solid fa-code-compare"></i> Compare!
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal per modificare switch -->
        <div id="edit-modal" class="modal">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <div class="modal-title">Modify Device</div>
                    <span class="close-btn" onclick="closeEditModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="split-view">
                        <div class="form-column">
                            <div class="form-group">
                                <label for="edit-hostname">Hostname:</label>
                                <input type="text" id="edit-hostname">
                            </div>
                            <div class="form-group">
                                <label for="edit-ip">IP Address:</label>
                                <input type="text" id="edit-ip">
                            </div>
                            <div class="form-group">
                                <label for="edit-device-type">Device Type:</label>
                                <select id="edit-device-type" class="form-control">
                                    <option value="cisco_ios">cisco_ios</option>
                                    <option value="cisco_xe">cisco_xe</option>
                                    <option value="cisco_xr">cisco_xr</option>
                                    <option value="huawei">huawei</option>
                                    <option value="juniper_junos">juniper_junos</option>
                                    <option value="mellanox">mellanox</option>
                                    <option value="mellanox_mlnxos">mellanox_mlnxos</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-column">
                            <div class="form-group">
                                <label for="edit-username">Username:</label>
                                <input type="text" id="edit-username">
                            </div>
                            <div class="form-group">
                                <label for="edit-password">Password:</label>
                                <input type="password" id="edit-password" placeholder="Leave blank to keep current">
                            </div>
                            <div class="form-group">
                                <label for="edit-enable-password">Enable Password:</label>
                                <input type="password" id="edit-enable-password" placeholder="Leave blank to keep current">
                            </div>
                        </div>
                    </div>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button onclick="closeEditModal()">Cancel</button>
                    <button class="backup-btn" onclick="saveEditedSwitch()" style="margin-left: 10px;">Save changes</button>
                </div>
                <input type="hidden" id="edit-index">
            </div>
        </div>

        <!-- Modal per visualizzare il log completo -->
        <div id="log-modal" class="modal">
            <div class="log-modal-content">
                <div class="modal-header">
                    <div class="modal-title">Complete log activity</div>
                    <span class="close-btn" onclick="closeLogModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div id="full-log-content" class="log-content"></div>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button onclick="closeLogModal()">Close</button>
                </div>
            </div>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
        
        <script>
            let switchesPerPage = 15;
            let currentSortColumn = -1;
            let sortDirection = 1;
            let currentPage = 1;
            let allSwitches = [];
            let filteredSwitches = [];

            window.eval = function() {
                throw new Error("eval() is disabled for security reasons");
            };

            // Funzione di utilità per escape HTML
            function escapeHtml(unsafe) {
                return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
            }

            function changeItemsPerPage() {
                const select = document.getElementById('items-per-page');
                switchesPerPage = parseInt(select.value);
                currentPage = 1; // Resetta alla prima pagina quando cambi il numero di elementi
                renderSwitches();
                updatePagination();
            }

            function safeInsert(text) {
                return text.replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
            }

            function filterSwitches() {
                const searchTerm = document.getElementById('search-input').value.toLowerCase();

                if (searchTerm.trim() === '') {
                    filteredSwitches = [...allSwitches];
                } else {
                    filteredSwitches = allSwitches.filter(sw => 
                        sw.hostname.toLowerCase().includes(searchTerm) || 
                        sw.ip.toLowerCase().includes(searchTerm) ||
                        (sw.username && sw.username.toLowerCase().includes(searchTerm)) ||
                        sw.device_type.toLowerCase().includes(searchTerm)
                    );
                }

                currentPage = 1; // Resetta alla prima pagina quando filtri
                renderSwitches();
                updatePagination();
            }


            function renderSwitches() {
                const tbody = document.getElementById('switches-table-tbody');
                tbody.innerHTML = '';

                if (filteredSwitches.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No matching devices found</td></tr>';
                    return;
                }

                const startIndex = (currentPage - 1) * switchesPerPage;
                const endIndex = Math.min(startIndex + switchesPerPage, filteredSwitches.length);
                const switchesToShow = filteredSwitches.slice(startIndex, endIndex);

                switchesToShow.forEach((sw, i) => {
                const row = document.createElement('tr');
                row.innerHTML = `
<td>
    <span class="backup-status" id="status-${sw.originalIndex}" title="${getStatusTooltip(sw)}">
        <i class="fas fa-circle" style="color: ${getStatusColor(sw)}; font-size: 10px; margin-right: 5px;"></i>
    </span>
    ${highlightMatches(sw.hostname)}
</td>
<td>${highlightMatches(sw.ip)}</td>
<td>${highlightMatches(sw.username)}</td>
<td>
    <button class="action-btn backup-btn" title="Backup" onclick="backupSwitch(${sw.originalIndex})">
        <i class="fas fa-download"></i>
    </button>
    <button class="action-btn edit-btn" title="Modifica" onclick="openEditModal(${sw.originalIndex})">
        <i class="fas fa-edit"></i>
    </button>
    <button class="action-btn view-btn" title="Visualizza Backup" onclick="openConfigModal(${sw.originalIndex})">
        <i class="fas fa-eye"></i>
    </button>
    <button class="action-btn delete-btn" title="Elimina" onclick="deleteSwitch(${sw.originalIndex})">
        <i class="fas fa-trash"></i>
    </button>
</td>
                `;
                tbody.appendChild(row);
                });
            }

            function getStatusColor(switchData) {
                if (!switchData.last_backup_status) return 'gray'; // mai eseguito
                if (switchData.last_backup_status === 'success') return 'green'; //backup ok
                if (switchData.last_backup_status === 'failed') return 'red'; // backup fallito
                return 'gray';
            }

            function getStatusTooltip(switchData) {
                if (!switchData.last_backup_status) return 'Backup never attempted';

                if (switchData.last_backup_status === 'success') 
                return `Last successful backup: ${switchData.last_backup_time}`;

                if (switchData.last_backup_status === 'failed') 
                return `Last backup failed: ${switchData.last_backup_time}`;

                return 'Unknown status';
            }



            function highlightMatches(text) {
                const searchTerm = document.getElementById('search-input').value.toLowerCase();

                if (!text) return ''; // Aggiunto controllo per valori null/undefined
                if (!searchTerm || !text) return text;

                const str = text.toString();
                const lowerStr = str.toLowerCase();
                const termLower = searchTerm.toLowerCase();

                let result = '';
                let lastIndex = 0;
                let index = lowerStr.indexOf(termLower);

                while (index >= 0) {
                    result += str.substring(lastIndex, index) + 
                    '<span style="background-color: yellow;">' + 
                    str.substring(index, index + searchTerm.length) + 
                    '</span>';

                    lastIndex = index + searchTerm.length;
                    index = lowerStr.indexOf(termLower, lastIndex);
                }

                result += str.substring(lastIndex);
                return result;
            }

            function updatePagination() {
                const pageCount = Math.ceil(filteredSwitches.length / switchesPerPage);
                const paginationDiv = document.getElementById('pagination');
                paginationDiv.innerHTML = '';

                // Aggiorna la selezione nel menu a tendina
                document.getElementById('items-per-page').value = switchesPerPage;

                // Funzione per pulire tutti gli stati attivi
                const clearActiveStates = () => {
                    document.querySelectorAll('#pagination button').forEach(b => {
                        b.classList.remove('active');
                        b.disabled = false;
                    });
                };

                // Pulsante "Indietro"
                const prevBtn = document.createElement('button');
                prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                prevBtn.disabled = currentPage === 1;

                prevBtn.onclick = () => {
                    if (currentPage > 1) {
                        clearActiveStates();
                        currentPage--;
                        renderSwitches();
                        updatePagination();
                    }
                };

                paginationDiv.appendChild(prevBtn);

                // Pulsanti numerici
                for (let i = 1; i <= pageCount; i++) {
                    const btn = document.createElement('button');
                    btn.textContent = i;

                    btn.onclick = () => {
                        clearActiveStates();
                        currentPage = i;
                        btn.classList.add('active');
                        btn.disabled = true;
                        renderSwitches();
                        updatePagination();
                    };

                    if (i === currentPage) {
                        btn.classList.add('active');
                        btn.disabled = true;
                    }

                    paginationDiv.appendChild(btn);
                }

                // Pulsante "Avanti"
                const nextBtn = document.createElement('button');
                nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                nextBtn.disabled = currentPage >= pageCount;

                nextBtn.onclick = () => {
                    if (currentPage < pageCount) {
                        clearActiveStates();
                        currentPage++;
                        renderSwitches();
                        updatePagination();
                    }
                };

                paginationDiv.appendChild(nextBtn);

                if (pageCount === 0) {
                    paginationDiv.innerHTML = '<span>No devices found</span>';
                }
            }

            function addSwitch() {
                const hostname = document.getElementById('hostname').value;
                const ip = document.getElementById('ip').value;
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const enablePassword = document.getElementById('enable-password').value;
                const deviceType = document.getElementById('device-type').value;

                if (!hostname || !ip || !username || !password) {
                    showStatus('Please fill all required fields', 'error');
                    return;
                }

                const switchData = { 
                    hostname, 
                    ip, 
                    username, 
                    password,
                    device_type: deviceType
                };

                if (enablePassword) {
                    switchData.enable_password = enablePassword;
                }

                fetch('/add_switch', {
                    method: 'POST',
                    headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify(switchData),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateSwitchTable();
                        document.getElementById('hostname').value = '';
                        document.getElementById('ip').value = '';
                        document.getElementById('username').value = '';
                        document.getElementById('password').value = '';
                        showStatus('Switch aggiunto con successo', 'success');
                        addToLog(`Device ${hostname} (${ip}) added to the list`);
                    } else {
                        showStatus('Error: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    showStatus('Connection error: ' + error, 'error');
                });
            }
            
            function uploadCSV() {
                const fileInput = document.getElementById('csv-file');
                const file = fileInput.files[0];

                if (!file) {
                    showStatus('Select a CSV file to load', 'error');
                    return;
                }

                const formData = new FormData();
                formData.append('csv_file', file);

                fetch('/upload_csv', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': getCSRFToken()
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        showStatus(`Loaded ${data.added} devices from CSV (${data.skipped} already in the list)`, 'success');
                        addToLog(`Loaded ${data.added} devices from CSV file`);
                        updateSwitchTable();
                        fileInput.value = '';
                    } else {
                        showStatus('Error: ' + data.message, 'error');
                        addToLog(`CSV load failed: ${data.message}`);
                    }
                })
                .catch(error => {
                    showStatus('Error: ' + error.message, 'error');
                    addToLog(`Error during CSV load: ${error.message}`);
                });
            }

            function sortTable(columnIndex) {
                if (currentSortColumn === columnIndex) {
                    sortDirection *= -1;
                } else {
                    currentSortColumn = columnIndex;
                    sortDirection = 1;
                }

                // Ordina filteredSwitches invece di fare una nuova richiesta
                filteredSwitches.sort((a, b) => {
                    const keys = ['hostname', 'ip', 'username'];
                    const key = keys[columnIndex];
                    const valA = a[key]?.toLowerCase() || '';
                    const valB = b[key]?.toLowerCase() || '';

                    if (valA < valB) return -1 * sortDirection;
                    if (valA > valB) return 1 * sortDirection;

                    return 0;
                });

                currentPage = 1; // Resetta alla prima pagina quando si ordina
                renderSwitches();
                updatePagination();
                updateSortIcons();
            }

            function updateSwitchTable() {
                fetch('/get_switches')
                .then(response => response.json())
                .then(switchesData => {
                    allSwitches = switchesData.map((sw, index) => ({...sw, originalIndex: index}));
                    filteredSwitches = [...allSwitches];

                    renderSwitches();
                    updatePagination();
                    updateSortIcons();

                    filterSwitches();
                })
                .catch(error => {
                    console.error('Device load failed:', error);
                    const tbody = document.getElementById('switches-table-tbody');
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: red;">Error during the device update</td></tr>';
                });
            }

            function updateSortIcons() {
                const headers = document.querySelectorAll('.switch-table th');

                headers.forEach((header, index) => {
                    const icon = header.querySelector('i');
                    if (icon) {
                        if (index === currentSortColumn) {
                            icon.className = sortDirection === 1 ? 'fas fa-sort-up' : 'fas fa-sort-down';
                        } else {
                            icon.className = 'fas fa-sort';
                        }
                    }
                });
            }

            function deleteSwitch(index) {
                fetch('/get_switches')
                .then(response => response.json())
                .then(switchesData => {
                    if (index >= 0 && index < switchesData.length) {
                        const hostname = switchesData[index].hostname;

                        if (!confirm(`Are you sure you wanna deleted the device ${hostname}?`)) {
                            return;
                        }

                        fetch('/delete_switch', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCSRFToken()
                            },
                            body: JSON.stringify({ index: index }),
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                updateSwitchTable();
                                updateSchedulesList();
                                showStatus(`Device ${hostname} deleted successfully`, 'success');
                                addToLog(`Device ${hostname} removed from list`);
                            } else {
                                showStatus('Error: ' + data.message, 'error');
                                addToLog(`ERROR - device delete failed ${hostname}: ${data.message}`);
                            }
                        })
                        .catch(error => {
                            showStatus('Connection error: ' + error, 'error');
                            addToLog(`ERROR - device delete failed: ${error}`);
                        });
                    }
                });
            }

            function backupSwitch(index) {
                // Prima recuperiamo i dati dello switch per ottenere l'hostname
                fetch('/get_switches')
                .then(response => response.json())
                .then(switchesData => {
                    if (index >= 0 && index < switchesData.length) {
                        const switchData = switchesData[index];
                        const statusMessage = `Starting backup for ${switchData.hostname} (${switchData.ip})...`;
                        showStatus(statusMessage, 'success');
                        addToLog(statusMessage);

                        // Poi eseguiamo il backup
                        fetch('/backup_switch', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCSRFToken()
                            },
                            body: JSON.stringify({ index: parseInt(index) }),
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                const successMessage = `Backup completed for ${data.hostname}`;
                                showStatus(successMessage, 'success');
                                addToLog(successMessage);
                                addToLog(`Config saved at: ${data.filename}`);
                            } else {
                                const errorMessage = `Backup error for ${switchData.hostname}: ${data.message}`;
                                showStatus(errorMessage, 'error');
                                addToLog(`ERROR - backup failed for ${switchData.hostname}: ${data.message}`);
                            }
                        })
                        .catch(error => {
                            const errorMessage = `Connection error for ${switchData.hostname}: ${error}`;
                            showStatus(errorMessage, 'error');
                            addToLog(`ERROR - Connection failed for ${switchData.hostname}: ${error}`);
                        });
                    }
                })
                .catch(error => {
                    const errorMessage = `Error fetching switch data: ${error}`;
                    showStatus(errorMessage, 'error');
                    addToLog(`ERROR - Failed to get switch data: ${error}`);
                });
            }

            function backupAllSwitches() {
                addToLog('Starting backup for all devices...');

                fetch('/backup_all_switches', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showStatus(`Backup completato per ${data.count} switch`, 'success');
                        data.results.forEach(result => {
                            if (result.success) {
                                addToLog(`Backup completato per ${result.hostname} (${result.ip})`);
                            } else {
                                addToLog(`ERROR during the backup of ${result.hostname}: ${result.message}`);
                            }
                        });
                    } else {
                        showStatus('Error: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    showStatus('Connection error: ' + error, 'error');
                });
            }
            
            function backupAllSwitches() {
                const statusMessage = 'Starting backup for all devices...';
                showStatus(statusMessage, 'success');
                addToLog(statusMessage);

                fetch('/backup_all_switches', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const successMessage = `Backup completed for ${data.count} devices`;
                        showStatus(successMessage, 'success');
                        data.results.forEach(result => {
                            if (result.success) {
                                addToLog(`Backup completed for ${result.hostname} (${result.ip})`);
                            } else {
                                addToLog(`ERROR during the backup of ${result.hostname}: ${result.message}`);
                            }
                        });
                    } else {
                        const errorMessage = `Backup error: ${data.message}`;
                        showStatus(errorMessage, 'error');
                    }
                })
                .catch(error => {
                    const errorMessage = `Connection error: ${error}`;
                    showStatus(errorMessage, 'error');
                });
            }

            function openCompareSelectModal(index) {
                alert("è una vera BOMBA!!")
                fetch('/get_switch_backups', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({ index }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const modal = document.getElementById('compare-select-modal');
                        const switchName = document.getElementById('modal-switch-name');
                        const backupList = document.getElementById('backup-list');
                        const compareConfirmBtn = document.getElementById('compare-confirm-btn');

                        switchName.textContent = data.hostname;
                        backupList.innerHTML = '';

                        // Imposta l'indice dello switch sul pulsante Export All
                        compareConfirmBtn.setAttribute('data-switch-index', index);

                        if (data.backups.length === 0) {
                            backupList.innerHTML = '<p>No available backups</p>';
                            compareConfirmBtn.disabled = true;
                            compareConfirmBtn.title = 'No backups available';
                            compareConfirmBtn.style.opacity = '0.5';
                            compareConfirmBtn.style.cursor = 'not-allowed';
                        } else {
                            data.backups.forEach(backup => {
                                const backupItem = document.createElement('div');
                                backupItem.className = 'backup-item';
                                backupItem.textContent = backup.filename;
                                backupItem.setAttribute('data-path', backup.path); // Aggiungi questa linea
                                backupList.appendChild(backupItem);
                            });

                            compareConfirmBtn.disabled = false;
                            compareConfirmBtn.title = 'Compare the configuration';
                            compareConfirmBtn.style.opacity = '1';
                            compareConfirmBtn.style.cursor = 'pointer';
                        }

                        document.getElementById('backup-content').style.display = 'none';
                        document.getElementById('backup-content-placeholder').style.display = 'block';
                        modal.style.display = 'block';
                    } else {
                        showStatus('Error: ' + data.message, 'error');
                    }
                });

                document.addEventListener('keydown', handleEscCompareSelectModal);
            }

            /*function openConfigModal(index) {
                fetch('/get_switch_backups', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({ index }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const modal = document.getElementById('backup-modal');
                        const switchName = document.getElementById('modal-switch-name');
                        const backupList = document.getElementById('backup-list');

                        switchName.textContent = data.hostname;
                        backupList.innerHTML = '';

                        if (data.backups.length === 0) {
                            backupList.innerHTML = '<p>No avalaible backup</p>';
                        } else {
                            data.backups.forEach(backup => {
                                const backupItem = document.createElement('div');
                                backupItem.className = 'backup-item';
                                backupItem.textContent = backup.filename;
                                backupItem.onclick = () => loadBackupContent(backup.path, index);
                                backupList.appendChild(backupItem);
                            });
                        }

                        document.getElementById('backup-content').style.display = 'none';
                        document.getElementById('backup-content-placeholder').style.display = 'block';
                        modal.style.display = 'block';
                    } else {
                        showStatus('Error: ' + data.message, 'error');
                    }
                });

                document.addEventListener('keydown', handleEscConfigModal);
            }*/

            /*
            function openConfigModal(index) {
            fetch('/get_switch_backups', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({ index }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const modal = document.getElementById('backup-modal');
                    const switchName = document.getElementById('modal-switch-name');
                    const backupList = document.getElementById('backup-list');
                    const exportAllBtn = document.getElementById('export-all-backup-btn');

                    switchName.textContent = data.hostname;
                    backupList.innerHTML = '';

                    // Imposta l'indice dello switch sul pulsante Export All
                    exportAllBtn.setAttribute('data-switch-index', index);
                    alert(exportAllBtn.getAttribute('data-switch-index'));
                    if (data.backups.length === 0) {
                        backupList.innerHTML = '<p>No available backups</p>';
                        exportAllBtn.disabled = true;
                        exportAllBtn.title = 'No backups available';
                        exportAllBtn.style.opacity = '0.5';
                        exportAllBtn.style.cursor = 'not-allowed';
                    } else {
                        data.backups.forEach(backup => {
                            const backupItem = document.createElement('div');
                            backupItem.className = 'backup-item';
                            backupItem.textContent = backup.filename;
                            backupItem.onclick = () => loadBackupContent(backup.path, index);
                            backupList.appendChild(backupItem);
                        });

                        exportAllBtn.disabled = false;
                        exportAllBtn.title = 'Export all backups as ZIP';
                        exportAllBtn.style.opacity = '1';
                        exportAllBtn.style.cursor = 'pointer';
                    }

                    document.getElementById('backup-content').style.display = 'none';
                    document.getElementById('backup-content-placeholder').style.display = 'block';
                    modal.style.display = 'block';
                } else {
                    showStatus('Error: ' + data.message, 'error');
                }
            });
            }
            */
            
            function openConfigModal(index) {
                fetch('/get_switch_backups', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({ index }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const modal = document.getElementById('backup-modal');
                        const switchName = document.getElementById('modal-switch-name');
                        const backupList = document.getElementById('backup-list');
                        const exportAllBtn = document.getElementById('export-all-backup-btn');
                        const backupButtonBar = document.getElementById('backup-button-bar');

                        switchName.textContent = data.hostname;
                        backupList.innerHTML = '';

                        backupButtonBar.innerHTML = `
<button class="action-btn compare-btn" id="compare-select-btn" onclick="openCompareSelectModal(${index})" style="padding: 5px 12px; font-size: 13px;">
    <i class="fa-solid fa-code-compare"></i> Compare
</button>
<button class="action-btn backup-btn" id="export-backup-btn" style="padding: 5px 12px; font-size: 13px;">
    <i class="fas fa-download"></i> Export
</button>
<button class="action-btn delete-btn" id="delete-backup-btn" style="padding: 5px 12px; font-size: 13px;">
    <i class="fas fa-trash"></i> Delete
</button>
`

                        // Imposta l'indice dello switch sul pulsante Export All
                        exportAllBtn.setAttribute('data-switch-index', index);

                        if (data.backups.length === 0) {
                            backupList.innerHTML = '<p>No available backups</p>';
                            exportAllBtn.disabled = true;
                            exportAllBtn.title = 'No backups available';
                            exportAllBtn.style.opacity = '0.5';
                            exportAllBtn.style.cursor = 'not-allowed';
                        } else {
                            data.backups.forEach(backup => {
                                const backupItem = document.createElement('div');
                                backupItem.className = 'backup-item';
                                backupItem.textContent = backup.filename;
                                backupItem.setAttribute('data-path', backup.path);
                                backupItem.onclick = () => loadBackupContent(backup.path, index);
                                backupList.appendChild(backupItem);
                            });

                            exportAllBtn.disabled = false;
                            exportAllBtn.title = 'Export all backups as ZIP';
                            exportAllBtn.style.opacity = '1';
                            exportAllBtn.style.cursor = 'pointer';
                        }

                        document.getElementById('backup-content').style.display = 'none';
                        document.getElementById('backup-content-placeholder').style.display = 'block';
                        modal.style.display = 'block';
                    } else {
                        showStatus('Error: ' + data.message, 'error');
                    }
                });

                document.addEventListener('keydown', handleEscConfigModal);
            }
           
            function loadBackupContent(filepath, switchIndex) {
                fetch('/get_backup_content', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({ filepath }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const contentDiv = document.getElementById('backup-content');
                        const placeholder = document.getElementById('backup-content-placeholder');
                        const configContent = document.querySelector('#backup-content .config-content');
                        const compareBtn = document.getElementById('compare-select-btn');
                        const exportBtn = document.getElementById('export-backup-btn');
                        const deleteBtn = document.getElementById('delete-backup-btn');

                        configContent.textContent = data.content;

                        contentDiv.style.display = 'flex';
                        placeholder.style.display = 'none';
                        compareBtn.style.display = 'inline-block';
                        exportBtn.style.display = 'inline-block';
                        deleteBtn.style.display = 'inline-block';
                        deleteBtn.setAttribute('data-filepath', filepath);
                        deleteBtn.setAttribute('data-switch-index', switchIndex);

                        // Evidenzia il backup selezionato nella lista
                        document.querySelectorAll('.backup-item').forEach(item => {
                            item.classList.toggle('active', item.textContent.includes(data.filename));
                        });
                    }
                });
            }
            
            /*
            function exportAllBackup() {
                const switchIndex = document.getElementById('export-all-backup-btn').getAttribute('data-switch-index');
                if (!switchIndex) {
                    showStatus('No device selected for export', 'error');
                    return;
                }

                // Disabilita il pulsante durante l'export
                const exportBtn = document.getElementById('export-all-backup-btn');
                exportBtn.disabled = true;
                exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';

                showStatus('Preparing all backups for export...', 'success');

                fetch('/export_all_backups', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({ index: switchIndex }),
                })
                .then(response => {
                if (!response.ok) {
                    // Se la risposta non è OK, verifica se è perché non ci sono backup
                    if (response.status === 404) {
                        throw new Error('No backups found for this device');
                    }
                        throw new Error('Network response was not ok');
                    }
                    return response.blob();
                })
                .then(blob => {
                    if (blob.size === 0) {
                        throw new Error('Received empty ZIP file');
                    }

                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;

                    const hostname = document.getElementById('modal-switch-name').textContent.trim();
                    a.download = `${hostname}_all_backups_${new Date().toISOString().slice(0, 10)}.zip`;

                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    showStatus(`All backups for ${hostname} exported successfully as ZIP`, 'success');
                    addToLog(`Exported all backups for ${hostname} as ZIP file`);
                })
                .catch(error => {
                    showStatus('Export failed: ' + error.message, 'error');
                    addToLog(`ERROR exporting backups: ${error.message}`);
                })
                .finally(() => {
                    // Riabilita il pulsante
                    exportBtn.disabled = false;
                    exportBtn.innerHTML = '<i class="fa-solid fa-code-compare"></i> Export All';
                });
            }
            */

            function exportAllBackup() {
                const backupItems = document.querySelectorAll('.backup-item');
                if (backupItems.length === 0) {
                    showStatus('No backups available for export', 'error');
                    return;
                }

                const switchName = document.getElementById('modal-switch-name').textContent.trim();
                showStatus('Preparing all backups for export...', 'success');

                // Recupera tutti i percorsi dei backup dalla lista già caricata
                const backups = [];
                backupItems.forEach(item => {
                    backups.push({
                        filename: item.textContent,
                        path: item.getAttribute('data-path') || ''
                    });
                });

                // Chiamata al backend per creare lo ZIP
                fetch('/export_all_backups', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({ 
                        backups: backups,
                        hostname: switchName
                    }),
                })
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${switchName}_all_backups_${new Date().toISOString().slice(0, 10)}.zip`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    showStatus(`All backups exported successfully`, 'success');
                })
                .catch(error => {
                    showStatus('Export failed: ' + error, 'error');
                });
            }

            function exportBackup() {
                const configContent = document.querySelector('#backup-content .config-content').textContent;
                const filename = document.querySelector('.backup-item.active').textContent;

                // Crea un blob con il contenuto
                const blob = new Blob([configContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);

                // Crea un link temporaneo e simula il click
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();

                // Pulisci
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showStatus('Backup exported successfully', 'success');
                addToLog(`Exported backup: ${filename}`);
            }

            function deleteBackup() {
                const currentBackupPath = document.getElementById('delete-backup-btn').getAttribute('data-filepath');
                if (!currentBackupPath) return;

                if (!confirm('Are you sure you want to delete this backup? This action cannot be undone.')) {
                    return;
                }

                fetch('/delete_backup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({ filepath: currentBackupPath }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showStatus('Backup deleted successfully', 'success');
                        addToLog(`Deleted backup: ${currentBackupPath}`);
                        closeConfigModal();
                        // Se stavi visualizzando i backup di uno switch specifico, potresti voler ricaricare la lista
                        const currentSwitchIndex = document.getElementById('delete-backup-btn').getAttribute('data-switch-index');

                        if (currentSwitchIndex) {
                            openConfigModal(currentSwitchIndex);
                        }
                    } else {
                        showStatus('Error: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    showStatus('Connection error: ' + error, 'error');
                });
            }

            function copyToClipboard(element) {
                const configContent = element.querySelector('pre').textContent;
                navigator.clipboard.writeText(configContent).then(() => {
                    const tooltip = element.querySelector('.tooltiptext');
                    tooltip.textContent = '✓ Copied!';
                    element.classList.add('copied');

                    setTimeout(() => {
                        tooltip.textContent = 'Copy to clipboard';
                        element.classList.remove('copied');
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    element.querySelector('.tooltiptext').textContent = '✗ Failed to copy!';
                });
            }

            function closeConfigModal() {
                document.getElementById('backup-modal').style.display = 'none';
                document.getElementById('compare-select-btn').style.display = 'none';
                document.getElementById('export-backup-btn').style.display = 'none';
                document.getElementById('delete-backup-btn').style.display = 'none';

                document.removeEventListener('keydown', handleEscConfigModal);
            }

            function closeCompareSelectModal() {
                document.getElementById('compare-select-modal').style.display = 'none';
                document.removeEventListener('keydown', handleEscConfigModal);
            }

            function openEditModal(index) {
                fetch('/get_switches')
                .then(response => response.json())
                .then(switchesData => {
                    if (index >= 0 && index < switchesData.length) {
                        const switchData = switchesData[index];

                        document.getElementById('edit-hostname').value = switchData.hostname;
                        document.getElementById('edit-ip').value = switchData.ip;
                        document.getElementById('edit-device-type').value = switchData.device_type;
                        document.getElementById('edit-username').value = switchData.username;
                        document.getElementById('edit-password').value = '';
                        document.getElementById('edit-enable-password').value = '';
                        document.getElementById('edit-index').value = index;

                        document.getElementById('edit-modal').style.display = 'block';
                    }
                });

                document.addEventListener('keydown', handleEscEditModal);
            }

            function saveEditedSwitch() {
                const index = document.getElementById('edit-index').value;
                const hostname = document.getElementById('edit-hostname').value;
                const ip = document.getElementById('edit-ip').value;
                const username = document.getElementById('edit-username').value;
                const password = document.getElementById('edit-password').value;
                const enablePassword = document.getElementById('edit-enable-password').value;
                const deviceType = document.getElementById('edit-device-type').value;

                if (!hostname || !ip || !username) {
                    showStatus('Please fill all required fields', 'error');
                    return;
                }

                const switchData = {
                    index: parseInt(index),
                    hostname: hostname,
                    ip: ip,
                    username: username,
                    device_type: deviceType
                };

                if (password) {
                    switchData.password = password;
                }

                if (enablePassword) {
                    switchData.enable_password = enablePassword;
                }

                fetch('/update_switch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify(switchData),
                })
                .then(response => response.json())
                .then(data => {
                    // salvo elenco switch, aggiorno tabella switch e schedule, e ripristino eventuale ricerca
                    if (data.success) {
                        updateSwitchTable();
                        updateSchedulesList();
                        closeEditModal();
                        showStatus('Device data updated successfully', 'success');
                        addToLog(`Device ${hostname} (${ip}) data updated`);
                    } else {
                        showStatus('Error: ' + data.message, 'error');
                    }
                });
            }

            function closeEditModal() {
                document.getElementById('edit-modal').style.display = 'none';
                document.removeEventListener('keydown', handleEscEditModal);
            }

            function showStatus(message, type) {
                const statusElement = document.getElementById('status-message');
                statusElement.textContent = message;
                statusElement.className = 'status ' + type;
                statusElement.style.display = 'block';

                // Auto-hide after 5 seconds
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 5000);
            }

            function addToLog(message) {
                const logElement = document.getElementById('log');
                const timestamp = new Date().toLocaleTimeString();
                const messageDiv = document.createElement('div');
                messageDiv.textContent = `[${timestamp}] ${message}`;

                // Aggiunge classi in base al tipo di messaggio
                if (message.includes('ERROR:')) {
                    messageDiv.style.color = '#ff6b6b';
                } else if (message.includes('Starting') || message.includes('Connected') || message.includes('Executing')) {
                    messageDiv.style.color = '#51cf66';
                } else if (message.includes('completed')) {
                    messageDiv.style.color = '#339af0';
                }

                logElement.insertBefore(messageDiv, logElement.firstChild);
                logElement.scrollTop = 0;
            }

            function colorLogLine(line) {
                const lowerLine = line.toLowerCase();
                if (lowerLine.includes('error') || lowerLine.includes('failed')) {
                    return `<div class="log-line error">${line}</div>`;
                } else if (lowerLine.includes('warning')) {
                    return `<div class="log-line warning">${line}</div>`;
                } else if (lowerLine.includes('success') || lowerLine.includes('completed')) {
                    return `<div class="log-line success">${line}</div>`;
                }

                return `<div class="log-line">${line}</div>`;
            }



            function openLogModal() {
                fetch('/get_full_log')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const modal = document.getElementById('log-modal');
                        const logContent = document.getElementById('full-log-content');

                        // Pulisci e formatta il log
                        const lines = data.log.match(/[^\r\n]+/g) || [];
                        logContent.innerHTML = lines
                        .filter(line => line.trim())
                        .map(line => `<div class="log-line">${line}</div>`)
                        .join('');

                        modal.style.display = 'block';
                    } else {
                        showStatus('Error: ' + data.message, 'error');
                    }
                });

                document.addEventListener('keydown', handleEscLogModal);
            }

            function closeLogModal() {
                document.getElementById('log-modal').style.display = 'none';
                document.removeEventListener('keydown', handleEscLogModal);
            }

            window.onclick = function(event) {
                const backupModal = document.getElementById('backup-modal');
                const editModal = document.getElementById('edit-modal');
                const logModal = document.getElementById('log-modal');
                const compareselectModal = document.getElementById('compare-select-modal');

                if (event.target === backupModal) {
                    backupModal.style.display = 'none';
                }
                if (event.target === editModal) {
                    editModal.style.display = 'none';
                }
                if (event.target === logModal) {
                    logModal.style.display = 'none';
                }
                if (event.target === compareselectModal) {
                    compareselectModal.style.display = 'none';
                }
            }

            function showScheduleOptions() {
                const type = document.getElementById('schedule-type').value;

                document.querySelectorAll('.schedule-option').forEach(option => {
                    option.classList.remove('active');
                });
                
                if (type === 'once') {
                    document.getElementById('once-option').classList.add('active');
                } else if (type === 'weekly') {
                    document.getElementById('weekly-option').classList.add('active');
                } else if (type === 'monthly') {
                    document.getElementById('monthly-option').classList.add('active');
                } else if (type === 'yearly') {
                    document.getElementById('yearly-option').classList.add('active');
                }
            }

            function addSchedule() {
                const type = document.getElementById('schedule-type').value;
                const time = document.getElementById('schedule-time').value;

                const scheduleData = {
                    type: type,
                    time: time,
                    enabled: true
                };

                if (type === 'once') {
                    const date = document.getElementById('schedule-date').value;
                    if (!date) {
                        showStatus('Seleziona una data valida', 'error');
                        return;
                    }
                    scheduleData.date = date;
                } else if (type === 'weekly') {
                    scheduleData.day_of_week = document.getElementById('schedule-day-week').value;
                } else if (type === 'monthly') {
                    scheduleData.day = document.getElementById('schedule-day-month').value;
                } else if (type === 'yearly') {
                    scheduleData.month = document.getElementById('schedule-month').value;
                    scheduleData.day = document.getElementById('schedule-day-year').value;
                }

                fetch('/add_schedule', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify(scheduleData),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showStatus('Pianificazione aggiunta con successo', 'success');
                        updateSchedulesList();
                    } else {
                        showStatus('Error: ' + data.message, 'error');
                    }
                });
            }

            function updateSchedulesList() {
                fetch('/get_schedules')
                .then(response => response.json())
                .then(schedules => {
                    const list = document.getElementById('schedules-list');
                    list.innerHTML = '';

                    if (schedules.length === 0) {
                        list.innerHTML = '<p>No active schedule</p>';
                        return;
                    }

                    schedules.forEach(schedule => {
                        const item = document.createElement('div');
                        item.className = 'schedule-item';

                        const description = getScheduleDescription(schedule);

                        item.innerHTML = `
<div class="schedule-item-header">
<span>${description}</span>
<div class="schedule-item-actions">
<button class="action-btn ${schedule.enabled ? 'edit-btn' : 'backup-btn'}" 
onclick="toggleSchedule('${schedule.id}', ${!schedule.enabled})">
<i class="fas fa-${schedule.enabled ? 'pause' : 'play'}"></i>
</button>
<button class="action-btn delete-btn" onclick="deleteSchedule('${schedule.id}')">
<i class="fas fa-trash"></i>
</button>
</div>
</div>
<div>Backup globale di tutti gli switch</div>
<div>Prossima esecuzione: ${schedule.next_run || 'N/A'}</div>
                        `;

                        list.appendChild(item);
                    });
                });
            }

            function toggleSchedule(scheduleId, enable) {
                fetch('/toggle_schedule', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({ id: scheduleId, enabled: enable }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showStatus(`Pianificazione ${enable ? 'attivata' : 'disattivata'}`, 'success');
                        updateSchedulesList();
                    } else {
                        showStatus('Error: ' + data.message, 'error');
                    }
                });
            }

            function deleteSchedule(scheduleId) {
                if (!confirm('Sei sicuro di voler eliminare questa pianificazione?')) {
                    return;
                }

                fetch('/delete_schedule', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({ id: scheduleId }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showStatus('Pianificazione eliminata', 'success');
                        updateSchedulesList();
                    } else {
                        showStatus('Error: ' + data.message, 'error');
                    }
                });
            }

            function getScheduleDescription(schedule) {
                let desc = '';
                const time = schedule.time || '00:00';

                switch (schedule.type) {
                    case 'once':
                        desc = `Una volta il ${schedule.date} alle ${time}`;
                        break;
                    case 'daily':
                        desc = `Giornaliero alle ${time}`;
                        break;
                    case 'weekly':
                        const days = ['Domenica', 'Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato'];
                        desc = `Settimanale ogni ${days[parseInt(schedule.day_of_week)]} alle ${time}`;
                        break;
                    case 'monthly':
                        desc = `Mensile il giorno ${schedule.day} alle ${time}`;
                        break;
                    case 'yearly':
                        const months = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 
                        'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
                        desc = `Annuale il ${schedule.day} ${months[parseInt(schedule.month) - 1]} alle ${time}`;
                        break;
                }

                return desc;
            }

            function getCSRFToken() {
                const name = 'csrf_token';
                const cookies = document.cookie.split(';');

                for (let cookie of cookies) {
                    let [key, value] = cookie.trim().split('=');
                    if (key === name) return decodeURIComponent(value);
                }

                return '';
            }

            function exportSwitchesToCSV() {
                fetch('/export_switches_csv')
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'switches_backup_' + new Date().toISOString().slice(0, 10) + '.csv';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    showStatus('Esportazione CSV completata', 'success');
                    addToLog('Esportata lista switch in formato CSV');
                });
            }

            function setupModalCloseOnEsc() {
                // Chiudi modali quando si preme ESC
                document.addEventListener('keydown', function(event) {
                    if (event.key === 'Escape') {
                        // Chiudi modale modifica switch
                        const editModal = document.getElementById('editSwitchModal');
                        if (editModal && editModal.style.display === 'block') {
                            closeEditModal();
                        }

                        // Chiudi modale visualizzazione log
                        const logModal = document.getElementById('viewLogModal');
                        if (logModal && logModal.style.display === 'block') {
                            closeLogModal();
                        }

                        // Chiudi modale visualizzazione configurazione
                        const configModal = document.getElementById('viewConfigModal');
                        if (configModal && configModal.style.display === 'block') {
                            closeConfigModal();
                        }
                    }
                });
            }


            function handleEscEditModal(event) {
                if (event.key === 'Escape') {
                    closeEditModal();
                }
            }


            function handleEscLogModal(event) {
                if (event.key === 'Escape') {
                    closeLogModal();
                }
            }


            function handleEscConfigModal(event) {
                if (event.key === 'Escape') {
                    closeConfigModal();
                }
            }
            
            function handleEscCompareSelectModal(event) {
                if (event.key === 'Escape') {
                    closeCompareSelectModal();
                }
            }

            document.addEventListener('DOMContentLoaded', function() {
                updateSwitchTable();
                showScheduleOptions();
                updateSchedulesList();

                const today = new Date().toISOString().split('T')[0];
                document.getElementById('schedule-date').min = today;
                document.getElementById('schedule-date').value = today;

                // Event listener per funzioni varie
                document.getElementById('export-backup-btn').addEventListener('click', exportBackup);
                document.getElementById('delete-backup-btn').addEventListener('click', deleteBackup);
            });

            window.addEventListener('DOMContentLoaded', function() {
                setupModalCloseOnEsc();
            });

            $(document).ready(function() {
                $('select').select2({
                    width: '100%',
                    dropdownAutoWidth: true,
                    theme: 'default'
                });
                $('#device-type, #edit-device-type').select2({
                    width: 'resolve', // Usa la larghezza dell'elemento originale
                    minimumResultsForSearch: Infinity // Disabilita la ricerca se pochi elementi
                });
            });
        </script>
    </body>
</html>